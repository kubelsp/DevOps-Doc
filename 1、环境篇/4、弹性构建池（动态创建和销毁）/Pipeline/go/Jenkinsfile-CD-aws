#!/usr/bin/env groovy
import groovy.json.JsonOutput

pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  name: jenkins-slave
  namespace: jenkins
spec:
  tolerations:
  - key: k8s-jenkins
    operator: Equal
    value: k8s-jenkins
    effect: NoSchedule
  imagePullSecrets:
  - name: ecr-regcred
  containers:
  - name: aws
    #image: docker:28.1.1
    image: 676206931376.dkr.ecr.ap-southeast-1.amazonaws.com/devops:aws
    imagePullPolicy: IfNotPresent
    command:
    - sleep
    args:
    - 99d
    volumeMounts:
    - name: latest-image-cache
      mountPath: /image
  - name: jnlp
    #image: ccr.ccs.tencentyun.com/huanghuanhui/jenkins-inbound-agent:3327.v868139a_d00e0-6
    image: jenkins/inbound-agent:3327.v868139a_d00e0-6
    imagePullPolicy: IfNotPresent
  volumes:
  - name: latest-image-cache
    persistentVolumeClaim:
      claimName: jenkins-slave-latest-image-cache
'''
        }
    }

    environment {
        AppName   = "${AppName}"
        GitRepo   = "${GitRepo}"
        GitBranch = "${GitBranch}"
        Server    = "${Server}"
        RepoName  = "${RepoName}"
        BaseImage = "${BaseImage}"
    }

    stages {

        stage('é‡‘ä¸é›€å‘å¸ƒ') {
            steps {
                container('aws') {
                    script {
                        // 1ï¸âƒ£ è·å–é•œåƒ
                        def latest = sh(script: "tail -n 1 /image/hhh-latest-images.sh || true", returnStdout: true).trim()
                        if (!latest) {
                            error("âŒ æœªæ‰¾åˆ°æœ€æ–°é•œåƒä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ /image/hhh-latest-images.sh æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹")
                        }

                        echo "ğŸ¯ ä½¿ç”¨é•œåƒ: ${latest}"

                        // 2ï¸âƒ£ æ›´æ–° EKS é…ç½®
                        sh '''
                        aws --version
                        aws sts get-caller-identity
                        aws eks update-kubeconfig --region ap-southeast-1 --name prod
                        kubectl get node
                        '''

                        // 3ï¸âƒ£ æ‰§è¡Œ Argo Rollouts æ›´æ–°é•œåƒ
                        sh """
                        kubectl argo rollouts set image hhh "*=${latest}" -n prod
                        
                        kubectl argo rollouts status hhh -n prod --watch --timeout=10m
                        """

                        // 4ï¸âƒ£ ä¿å­˜é•œåƒåœ°å€ä¾› post é˜¶æ®µä½¿ç”¨
                        env.LATEST_IMAGE = latest
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                // è·å–å½“å‰åŒ—äº¬æ—¶é—´
                def buildTime = new Date().format('yyyy-MM-dd HH:mm:ss', TimeZone.getTimeZone('Asia/Shanghai'))

                // è·å–è§¦å‘äºº
                def cause = currentBuild.getBuildCauses()[0]
                def user = cause.userName ?: "ç³»ç»Ÿè§¦å‘"
                
                def latest = env.LATEST_IMAGE ?: "unknown"
                def msg = """âœ… å‘å¸ƒæˆåŠŸï¼š
å›½å®¶ï¼šCN
ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒ
åº”ç”¨ï¼šhhh
é•œåƒï¼š${latest}
è¿è¡Œäººï¼š${user}
æ—¶é—´ï¼š${buildTime}
"""
                // âœ… ä½¿ç”¨ JsonOutput ç¡®ä¿åˆæ³• JSON
                def payload = JsonOutput.toJson([
                    msg_type: "text",
                    content: [text: msg]
                ])
                sh """
                curl -s -X POST \
                  -H 'Content-Type: application/json' \
                  -d '${payload}' \
                  "https://open.larksuite.com/open-apis/bot/v2/hook/202572e3-1a5e-4351-a633-a9f2897e2025"
                """
            }
        }

        failure {
            script {
                def msg = """âŒ æ„å»ºå¤±è´¥ï¼š
åº”ç”¨ï¼šhhh
"""
                def payload = JsonOutput.toJson([
                    msg_type: "text",
                    content: [text: msg]
                ])
                sh """
                curl -s -X POST \
                  -H 'Content-Type: application/json' \
                  -d '${payload}' \
                  "https://open.larksuite.com/open-apis/bot/v2/hook/202572e3-1a5e-4351-a633-a9f2897e2025"
                """
            }
        }
    }
}
